pipeline {
  agent any

  environment {
    BACKEND_IMAGE = 'bobnotavalible/delivery_progress/backend'
    FRONTEND_IMAGE = 'bobnotavalible/delivery_progress/frontend'
    SERVER_USER = 'ec2-user'
    SERVER_IP = '172.31.90.185'
  }

  stages {
    stage('Backend: Build & Save') {
      steps {
        dir('backend') {
          sh "docker build -t ${BACKEND_IMAGE} ."
        }
        sh "docker save ${BACKEND_IMAGE} -o backend.tar"
      }
    }
    stage('Frontend: Build & Save') {
      steps {
        dir('frontend') {
          sh "docker build -t ${FRONTEND_IMAGE} ."
        }
        sh "docker save ${FRONTEND_IMAGE} -o frontend.tar"
      }
    }
    stage('Copy Images to Target1') {
      steps {
        sh "scp backend.tar frontend.tar ${SERVER_USER}@${SERVER_IP}:/tmp/"
      }
    }
    stage('Deploy with Ansible') {
      steps {
        sh "ansible-playbook ansible/deploy.yml -i ansible/inventory"
      }
    }
  }
}
