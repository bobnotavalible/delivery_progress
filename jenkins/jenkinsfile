pipeline {
  agent any

  environment {
    BACKEND_IMAGE = 'your-podmanhub-username/backend'
    FRONTEND_IMAGE = 'your-podmanhub-username/frontend'
    SERVER_USER = 'ec2-user'
    SERVER_IP = '172.31.90.185'
  }

  stages {
    stage('Checkout from GitHub') {
      steps {
        // Клонирует репозиторий, где лежит Jenkinsfile
        checkout scm
        // Если нужно взять ещё что-то из другого репозитория:
        // git url: 'https://github.com/username/other-repo.git', branch: 'main'
      }
    }
    stage('Copy Images to Target1') {
      steps {
        sh scp -o StrictHostKeyChecking=no backend.tar frontend.tar ec2-user@172.31.90.185:/tmp/
      }
    }
    stage('Backend: Build & Save') {
      steps {
        dir('backend') {      
          sh "podman build -t ${BACKEND_IMAGE} ."
        }
        sh 'rm -f backend.tar'
        sh "podman save ${BACKEND_IMAGE} -o backend.tar"
      }
    }
    stage('Frontend: Build & Save') {
      steps {
        dir('frontend') {
          sh "podman build -t ${FRONTEND_IMAGE} ."
        }
        sh 'rm -f frontend.tar'
        sh "podman save ${FRONTEND_IMAGE} -o frontend.tar"
      }
    }
    stage('Copy Images to Target1') {
      steps {
        sh "scp backend.tar frontend.tar ${SERVER_USER}@${SERVER_IP}:/tmp/"
      }
    }
    stage('Deploy with Ansible') {
      steps {
        sh "ansible-playbook ansible/deploy.yml -i ansible/inventory"
      }
    }
  }
}
